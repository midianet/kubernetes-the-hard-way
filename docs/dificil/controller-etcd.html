<html>
    <head>
        <title>The Hard Way</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
        <link rel="stylesheet" href="../style.css">            
    </head>
    <body class="container">
        <div class="navbar">
            <p class="titulo">KUBERNETES THE HARD WAY (AWS) (Ubuntu)</p>
        </div>
        <div class="sidenav">
            <a href="./prerequisitos.html">Pré Requisitos</a>
            <a href="./maquinas.html">Máquinas</a>
            <a href="./certificados.html">Certificados</a>
            <a href="./configuracao.html">Configuração</a>
            <a href="./criptografia.html">Criptografia</a>
            <p class="current">ETCD</p>
            <a href="./controller-plane.html">Controllers</a>
            <a href="./worker.html">Workers</a>
            <a href="./kubectl.html">Kubectl</a>
            <a href="./rotas.html">Rotas</a>
            <a href="./dns.html">DNS</a>
            <a href="./teste.html">Teste</a>
            <a href="./dashboard.html">Dashboard</a>
            <a href="./destruir.html">Destruir</a>
        </div>
        <div class="main">
            <h2>Inicializando Cluster ETCD</h2>
            <h3>Pre Requisitos</h3>
            <div class="code">
                <p>for instance in controller-0 controller-1 controller-2; do</br>
                <span class="tab">external_ip=$(aws ec2 describe-instances --filters \</span></br>
                <span class="tab2">"Name=tag:Name,Values=${instance}" \</span></br>
                <span class="tab2">"Name=instance-state-name,Values=running" \</span></br>
                <span class="tab2">--output text --query 'Reservations[].Instances[].PublicIpAddress')</span></br>
                <span class="tab">echo ssh -i kubernetes.id_rsa ubuntu@$external_ip</span></br>
                done</p>
            </div>
            </br>
            <div class="atencao">Atenção: Abra 3 janelas novas de shell , se não tiver ambiente gráfico use o TMUX, ou faça uma por vez</br>
                Em cada janela nova execute um comando acima para se conectar ao controller-0, controller-1 e controller-2</br>
                Execute os comandos abaixo em cada uma das janelas:</div>
            </br>
            <div class="code-controller">
                <p>wget -q --show-progress --https-only --timestamping \</br>
                <span class="tab">"https://github.com/etcd-io/etcd/releases/download/v3.4.10/etcd-v3.4.10-linux-amd64.tar.gz"</span></p>
                <p>sudo chmod +x etcd-v3.4.10-linux-amd64.tar.gz</p>
                <p>tar -xvf etcd-v3.4.10-linux-amd64.tar.gz</br>
                <span class="tab">sudo mv etcd-v3.4.10-linux-amd64/etcd* /usr/local/bin/</span></p>
                <p>sudo mkdir -p /etc/etcd /var/lib/etcd</p>
                <p>sudo chmod 700 /var/lib/etcd</p>
                <p>sudo cp ca.pem kubernetes-key.pem kubernetes.pem /etc/etcd/</p>
                <p>INTERNAL_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)</p>
                <p>echo "$INTERNAL_IP"</p>
                <p>ETCD_NAME=$(curl -s http://169.254.169.254/latest/user-data/ \</br>
                <span class="tab">| tr "|" "\n" | grep "^name" | cut -d"=" -f2)</span></p>
                <p>echo "${ETCD_NAME}"</p>
            </div>
            <h4>Configurando ETCD Service</h4>
            <div class="code-controller">
                <p>cat  &lt;&lt;EOF | sudo tee /etc/systemd/system/etcd.service</br>
                [Unit]</br>
                Description=etcd</br>
                Documentation=https://github.com/coreos</br>
                </br>
                [Service]</br>
                ExecStart=/usr/local/bin/etcd \\</br>
                <span class="tab">--name ${ETCD_NAME} \\</span></br>
                <span class="tab">--cert-file=/etc/etcd/kubernetes.pem \\</span></br>
                <span class="tab">--key-file=/etc/etcd/kubernetes-key.pem \\</span></br>
                <span class="tab">--peer-cert-file=/etc/etcd/kubernetes.pem \\</span></br>
                <span class="tab">--peer-key-file=/etc/etcd/kubernetes-key.pem \\</span></br>
                <span class="tab">--trusted-ca-file=/etc/etcd/ca.pem \\</span></br>
                <span class="tab">--peer-trusted-ca-file=/etc/etcd/ca.pem \\</span></br>
                <span class="tab">--peer-client-cert-auth \\</span></br>
                <span class="tab">--client-cert-auth \\</span></br>
                <span class="tab">--initial-advertise-peer-urls https://${INTERNAL_IP}:2380 \\</span></br>
                <span class="tab">--listen-peer-urls https://${INTERNAL_IP}:2380 \\</span></br>
                <span class="tab">--listen-client-urls https://${INTERNAL_IP}:2379,https://127.0.0.1:2379 \\</span></br>
                <span class="tab">--advertise-client-urls https://${INTERNAL_IP}:2379 \\</span></br>
                <span class="tab">--initial-cluster-token etcd-cluster-0 \\</span></br>
                <span class="tab">--initial-cluster controller-0=https://10.0.1.10:2380,controller-1=https://10.0.1.11:2380,controller-2=https://10.0.1.12:2380 \\</span></br>
                <span class="tab">--initial-cluster-state new \\</span></br>
                <span class="tab">--data-dir=/var/lib/etcd</span></br>
                Restart=on-failure</br>
                RestartSec=5</br>
                </br>
                [Install]</br>
                WantedBy=multi-user.target</br>
                EOF</p>
            </div>
            <h4>Inicializando ETCD Service</h4>
            <div class="code-controller">
                <p>sudo systemctl daemon-reload</p>
                <p>sudo systemctl enable etcd</p>
                <p>sudo systemctl start etcd</p>
            </div>
            <h4>Verificando ETCD Service</h4>
            <div class="code-controller">
                <p>sudo ETCDCTL_API=3 etcdctl member list \</br>
                <span class="tab">--endpoints=https://127.0.0.1:2379 \</span></br>
                <span class="tab">--cacert=/etc/etcd/ca.pem \</span></br>
                <span class="tab">--cert=/etc/etcd/kubernetes.pem \</span></br>
                <span class="tab">--key=/etc/etcd/kubernetes-key.pem</span></p>
            </div>
            </br>
            <p>Resultado Esperado</p>
            <p>bbeedf10f5bbaa0c, started, controller-2, https://10.0.1.12:2380, https://10.0.1.12:2379, false</br>
            f9b0e395cb8278dc, started, controller-0, https://10.0.1.10:2380, https://10.0.1.10:2379, false</br>
            eecdfcb7e79fc5dd, started, controller-1, https://10.0.1.11:2380, https://10.0.1.11:2379, false</br></p>
        </div>
    </body>
</html>