<html>
    <head>
        <title>The Hard Way</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
        <link rel="stylesheet" href="../style.css">            
    </head>
    <body class="container">
        <div class="navbar">
            <a href="/">VOLTAR</a>
        </div>
        <div class="sidenav">
            <a href="./prerequisitos.html">Pré Requisitos</a>
            <a href="./maquinas.html">Máquinas</a>
            <a href="./certificados.html">Certificados</a>
            <p class="current">Configuração</p>
            <a href="./criptografia.html">Criptografia</a>
            <a href="./controller-etcd.html">ETCD</a>
            <a href="./controller-plane.html">Controllers</a>
            <a href="./worker.html">Workers</a>
            <a href="./kubectl.html">Kubectl</a>
            <a href="./rotas.html">Rotas</a>
            <a href="./dns.html">DNS</a>
            <a href="./teste.html">Teste</a>
            <a href="./dashboard.html">Dashboard</a>
            <a href="./destruir.html">Destruir</a>
        </div>
        <div class="main">
            <h2>Configuração de Autenticação</h2>
            <h3>Autenticação de cliente</h2>
            <p>TODO:ESCREVER AKI</p>
            <h3>Kubernetes DNS Público</h3>
            <div class="code">
                <p>KUBERNETES_PUBLIC_ADDRESS=$(aws elbv2 describe-load-balancers \</br>
                <span class="tab">--load-balancer-arns ${LOAD_BALANCER_ARN} \</span></br>
                <span class="tab">--output text --query 'LoadBalancers[0].DNSName')</span></p>
                <p>echo "$KUBERNETES_PUBLIC_ADDRESS"</p>
            </div>
            <h3>Kubeconfig (Workers)</h3>
            <div class="code">
                <p>for instance in worker-0 worker-1 worker-2; do</br>
                <span class="tab">kubectl config set-cluster kubernetes-the-hard-way \</span></br>
                <span class="tab2">--certificate-authority=ca.pem \</span></br>
                <span class="tab2">--embed-certs=true \</span></br>
                <span class="tab2">--server=https://${KUBERNETES_PUBLIC_ADDRESS}:443 \</span></br>
                <span class="tab2">--kubeconfig=${instance}.kubeconfig</span></br>
                <span class="tab">kubectl config set-credentials system:node:${instance} \</span></br>
                <span class="tab2">--client-certificate=${instance}.pem \</span></br>
                <span class="tab2">--client-key=${instance}-key.pem \</span></br>
                <span class="tab2">--embed-certs=true \</span></br>
                <span class="tab2">--kubeconfig=${instance}.kubeconfig</span></br>
                <span class="tab">kubectl config set-context default \</span></br>
                <span class="tab2">--cluster=kubernetes-the-hard-way \</span></br>
                <span class="tab2">--user=system:node:${instance} \</span></br>
                <span class="tab2">--kubeconfig=${instance}.kubeconfig</span></br>
                <span class="tab">kubectl config use-context default --kubeconfig=${instance}.kubeconfig</span></br>
                done</p>
                <p>ls worker-0.kubeconfig worker-1.kubeconfig worker-2.kubeconfig</p>
            </div>
            <h3>Kubeconfig (Proxy)</h3>
            <div class="code">
                <p>kubectl config set-cluster kubernetes-the-hard-way \</br>
                <span class="tab">--certificate-authority=ca.pem \</span></br>
                <span class="tab">--embed-certs=true \</span></br>
                <span class="tab">--server=https://${KUBERNETES_PUBLIC_ADDRESS}:443 \</span></br>
                <span class="tab">--kubeconfig=kube-proxy.kubeconfig</span></p>
                <p>kubectl config set-credentials system:kube-proxy \</br>
                <span class="tab">--client-certificate=kube-proxy.pem \</span></br>
                <span class="tab">--client-key=kube-proxy-key.pem \</span></br>
                <span class="tab">--embed-certs=true \</span></br>
                <span class="tab">--kubeconfig=kube-proxy.kubeconfig</span></p>
                <p>kubectl config set-context default \</br>
                <span class="tab">--cluster=kubernetes-the-hard-way \</span></br>
                <span class="tab">--user=system:kube-proxy \</span></br>
                <span class="tab">--kubeconfig=kube-proxy.kubeconfig</span></br>
                <p>kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</p>
                <p>cat kube-proxy.kubeconfig</p>
            </div>
            <h3>Kubeconfig (Controller)</h3>
            <div class="code">
                <p>kubectl config set-cluster kubernetes-the-hard-way \</br>
                <span class="tab">--certificate-authority=ca.pem \</span></br>
                <span class="tab">--embed-certs=true \</span></br>
                <span class="tab">--server=https://127.0.0.1:6443 \</span></br>
                <span class="tab">--kubeconfig=kube-controller-manager.kubeconfig</span></p>
                <p>kubectl config set-credentials system:kube-controller-manager \</span></br>
                <span class="tab">--client-certificate=kube-controller-manager.pem \</span></br>
                <span class="tab">--client-key=kube-controller-manager-key.pem \</span></br>
                <span class="tab">--embed-certs=true \</span></br>
                <span class="tab">--kubeconfig=kube-controller-manager.kubeconfig</span></p>
                <p>kubectl config set-context default \</span></br>
                <span class="tab">--cluster=kubernetes-the-hard-way \</span></br>
                <span class="tab">--user=system:kube-controller-manager \</span></br>
                <span class="tab">--kubeconfig=kube-controller-manager.kubeconfig</span></br>
                <p>kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</p>
                <p>cat kube-controller-manager.kubeconfig</p>
            </div>
            <h3>Kubeconfig (Scheduler)</h3>
            <div class="code">
                <p>kubectl config set-cluster kubernetes-the-hard-way \</br>
                <span class="tab">--certificate-authority=ca.pem \</span></br>
                <span class="tab">--embed-certs=true \</span></br>
                <span class="tab">--server=https://127.0.0.1:6443 \</span></br>
                <span class="tab">--kubeconfig=kube-scheduler.kubeconfig</span></p>
                <p>kubectl config set-credentials system:kube-scheduler \</br>
                <span class="tab">--client-certificate=kube-scheduler.pem \</span></br>
                <span class="tab">--client-key=kube-scheduler-key.pem \</span></br>
                <span class="tab">--embed-certs=true \</span></br>
                <span class="tab">--kubeconfig=kube-scheduler.kubeconfig</span></p>
                <p>kubectl config set-context default \</br>
                <span class="tab">--cluster=kubernetes-the-hard-way \</span></br>
                <span class="tab">--user=system:kube-scheduler \</span></br>
                <span class="tab">--kubeconfig=kube-scheduler.kubeconfig</span></p>
                <p>kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</p>
                <p>cat kube-scheduler.kubeconfig</p>
            </div>
            <h3>Kubeconfig (Admin)</h3>
            <div class="code">
                <p>kubectl config set-cluster kubernetes-the-hard-way \</br>
                <span class="tab">--certificate-authority=ca.pem \</span></br>
                <span class="tab">--embed-certs=true \</span></br>
                <span class="tab">--server=https://127.0.0.1:6443 \</span></br>
                <span class="tab">--kubeconfig=admin.kubeconfig</span></p>
                <p>kubectl config set-credentials admin \</br>
                <span class="tab">--client-certificate=admin.pem \</span></br>
                <span class="tab">--client-key=admin-key.pem \</span></br>
                <span class="tab">--embed-certs=true \</span></br>
                <span class="tab">--kubeconfig=admin.kubeconfig</span></p>
                <p>kubectl config set-context default \</br>
                <span class="tab">--cluster=kubernetes-the-hard-way \</span></br>
                <span class="tab">--user=admin \</span></br>
                <span class="tab">--kubeconfig=admin.kubeconfig</span></p>
                <p>kubectl config use-context default --kubeconfig=admin.kubeconfig</p>
                <p>cat admin.kubeconfig</p>
            </div>
            <h3>Distribuindo Kubeconfig (Workers)</h3>
            <div class="code">
                <p>for instance in worker-0 worker-1 worker-2; do</br>
                <span class="tab">external_ip=$(aws ec2 describe-instances --filters \</span></br>
                <span class="tab2">"Name=tag:Name,Values=${instance}" \</span></br>
                <span class="tab2">"Name=instance-state-name,Values=running" \</span></br>
                <span class="tab2">--output text --query 'Reservations[].Instances[].PublicIpAddress')</span></br>
                <span class="tab">scp -i kubernetes.id_rsa \</span></br>
                <span class="tab2">${instance}.kubeconfig kube-proxy.kubeconfig ubuntu@${external_ip}:~/</span></br>
                done</p>
            </div>
            <h3>Distribuindo Kubeconfig (Controllers)</h3>
            <div class="code">
                <p>for instance in controller-0 controller-1 controller-2; do</br>
                <span class="tab">external_ip=$(aws ec2 describe-instances --filters \</span></br>
                <span class="tab2">"Name=tag:Name,Values=${instance}" \</span></br>
                <span class="tab2">"Name=instance-state-name,Values=running" \</span></br>
                <span class="tab2">--output text --query 'Reservations[].Instances[].PublicIpAddress')</span></br>
                <span class="tab">scp -i kubernetes.id_rsa \</span></br>
                <span class="tab2">admin.kubeconfig kube-controller-manager.kubeconfig kube-scheduler.kubeconfig ubuntu@${external_ip}:~/</span></br>
                done</p>
            </div>    
        </div>
    </body>
</html>