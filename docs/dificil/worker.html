<html>
    <head>
        <title>The Hard Way</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
        <link rel="stylesheet" href="../style.css">            
    </head>
    <body class="container">
        <div class="navbar">
            <a href="/">VOLTAR</a>
        </div>
        <div class="sidenav">
            <a href="./prerequisitos.html">Pré Requisitos</a>
            <a href="./maquinas.html">Máquinas</a>
            <a href="./certificados.html">Certificados</a>
            <a href="./configuracao.html">Configuração</a>
            <a href="./criptografia.html">Criptografia</a>
            <a href="./controller-etcd.html">ETCD</a>
            <a href="./controller-plane.html">Controllers</a>
            <p class="current">Workers</p>
            <a href="./kubectl.html">Kubectl</a>
            <a href="./rotas.html">Rotas</a>
            <a href="./dns.html">DNS</a>
            <a href="./teste.html">Teste</a>
            <a href="./dashboard.html">Dashboard</a>
            <a href="./destruir.html">Destruir</a>
        </div>
        <div class="main">
            <h2>Inicializando os Workers (Nós)</h2>
            <h3>Pre Requisitos</h3>
            <div class="code">
                <p>for instance in worker-0 worker-1 worker-2; do</br>
                <span class="tab">external_ip=$(aws ec2 describe-instances --filters \</span></br>
                <span class="tab2">"Name=tag:Name,Values=${instance}" \</span></br>
                <span class="tab2">"Name=instance-state-name,Values=running" \</span></br>
                <span class="tab2">--output text --query 'Reservations[].Instances[].PublicIpAddress')</span></br>
                </br>
                <span class="tab">echo ssh -i kubernetes.id_rsa ubuntu@$external_ip</span></br>
                done</p>
            </div>
            <br/>
            <div class="atencao">Atenção: Abra 3 janelas novas de shell , se não tiver ambiente gráfico use o TMUX, ou faça uma por vez</br>
                Em cada janela nova execute um comando acima para se conectar ao worker-0, worker-1 e worker-2</br>
                Execute os comandos abaixo em cada uma das janelas:</div>
            </br>
            <h3>Provisionando o Worker (Nó)</h3>
            <div class="code-worker">
                <p>sudo apt-get update</p>
                <p>sudo apt-get -y install socat conntrack ipset</p>
            </div>
            <h3>Baixando os executáveis do Worker</h3>
            <div class="code-worker">
                <p>wget -q --show-progress --https-only --timestamping \</br>
                <span class="tab">https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.18.0/crictl-v1.18.0-linux-amd64.tar.gz \</span></br>
                <span class="tab">https://storage.googleapis.com/kubernetes-the-hard-way/runsc \</span></br>
                <span class="tab">https://github.com/opencontainers/runc/releases/download/v1.0.0-rc91/runc.amd64 \</span></br>
                <span class="tab">https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz \</span></br>
                <span class="tab">https://github.com/containerd/containerd/releases/download/v1.3.6/containerd-1.3.6-linux-amd64.tar.gz \</span></br>
                <span class="tab">https://storage.googleapis.com/kubernetes-release/release/v1.18.6/bin/linux/amd64/kubectl \</span></br>
                <span class="tab">https://storage.googleapis.com/kubernetes-release/release/v1.18.6/bin/linux/amd64/kube-proxy \</span></br>
                <span class="tab">https://storage.googleapis.com/kubernetes-release/release/v1.18.6/bin/linux/amd64/kubelet</span></p>
                <p>chmod +x *.tar.gz *.tgz</p>
                <p>sudo mkdir -p \</br>
                <span class="tab">/etc/cni/net.d \</span></br>
                <span class="tab">/opt/cni/bin \</span></br>
                <span class="tab">/var/lib/kubelet \</span></br>
                <span class="tab">/var/lib/kube-proxy \</span></br>
                <span class="tab">/var/lib/kubernetes \</span></br>
                <span class="tab">/var/run/kubernetes/p></span></p>
                <p>chmod +x kubectl kube-proxy kubelet runc.amd64 runsc</p>
                <p>sudo mv runc.amd64 runc</p>
                <p>sudo mv kubectl kube-proxy kubelet runc runsc /usr/local/bin/</p>
                <p>sudo tar -xvf crictl-v1.18.0-linux-amd64.tar.gz -C /usr/local/bin/</p>
                <p>sudo tar -xvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin/</p>
                <p>sudo tar -xvf containerd-1.3.6-linux-amd64.tar.gz</p>
                <p>sudo mv bin/* /bin/</p>
            </div>
            <h3>Configurando CNI</h3>
            <div class="code-worker">
                <p>POD_CIDR=$(curl -s http://169.254.169.254/latest/user-data/ \</br>
                <span class="tab">| tr "|" "\n" | grep "^pod-cidr" | cut -d"=" -f2)</span></br>
                echo "${POD_CIDR}"</p>
               <p>cat &lt;&lt;EOF | sudo tee /etc/cni/net.d/10-bridge.conf</br>
                {</br>
                <span class="tab">"cniVersion": "0.3.1",</span></br>
                <span class="tab">"name": "bridge",</span></br>
                <span class="tab">"type": "bridge",</span></br>
                <span class="tab">"bridge": "cnio0",</span></br>
                <span class="tab">"isGateway": true,</span></br>
                <span class="tab">"ipMasq": true,</span></br>
                <span class="tab">"ipam": {</span></br>
                <span class="tab2">"type": "host-local",</span></br>
                <span class="tab2">"ranges": [</span></br>
                <span class="tab3">[{"subnet": "${POD_CIDR}"}]</span></br>
                <span class="tab2">],</span></br>
                <span class="tab2">"routes": [{"dst": "0.0.0.0/0"}]</span></br>
                <span class="tab">}</span></br>
                }</br>
                EOF</p>
                <p>cat /etc/cni/net.d/10-bridge.conf</p>
                <p>cat &lt;&lt;EOF | sudo tee /etc/cni/net.d/99-loopback.conf</br>
                {</span></br>
                <span class="tab">"cniVersion": "0.3.1",</span></br>
                <span class="tab">"name": "lo",</span></br>
                <span class="tab">"type": "loopback"</span></br>
                }</br>
                EOF</p>
                <p>cat /etc/cni/net.d/99-loopback.conf</p>
            </div>
            <h3>Configurando Containerd</h3>
            <div class="code-worker">
                <p>sudo mkdir -p /etc/containerd/</p>
                <p>cat &lt;&lt;EOF | sudo tee /etc/containerd/config.toml</br>
                [plugins]</br>
                <span class="tab">[plugins.cri.containerd]</span></br>
                <span class="tab2">snapshotter = "overlayfs"</span></br>
                <span class="tab2">[plugins.cri.containerd.default_runtime]</span></br>
                <span class="tab3">runtime_type = "io.containerd.runtime.v1.linux"</span></br>
                <span class="tab3">runtime_engine = "/usr/local/bin/runc"</span></br>
                <span class="tab3">runtime_root = ""</span></br>
                <span class="tab2">[plugins.cri.containerd.untrusted_workload_runtime]</span></br>
                <span class="tab3">runtime_type = "io.containerd.runtime.v1.linux"</span></br>
                <span class="tab3">runtime_engine = "/usr/local/bin/runsc"</span></br>
                <span class="tab3">runtime_root = "/run/containerd/runsc"</span></br>
                EOF</p>
                <p>cat /etc/containerd/config.toml</p>
                <p>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/containerd.service</br>
                [Unit]</br>
                Description=containerd container runtime</br>
                Documentation=https://containerd.io</br>
                After=network.target</br>
                </br>    
                [Service]</br>
                ExecStartPre=/sbin/modprobe overlay</br>
                ExecStart=/bin/containerd</br>
                Restart=always</br>
                RestartSec=5</br>
                Delegate=yes</br>
                KillMode=process</br>
                OOMScoreAdjust=-999</br>
                LimitNOFILE=1048576</br>
                LimitNPROC=infinity</br>
                LimitCORE=infinity</br>
                </br>   
                [Install]</br>
                WantedBy=multi-user.target</br>
                EOF</p>
            </div>
            <h3>Configurando Kubelet</h3>
            <div class="code-worker">
                <p>WORKER_NAME=$(curl -s http://169.254.169.254/latest/user-data/ \</br>
                | tr "|" "\n" | grep "^name" | cut -d"=" -f2)</p>
                <p>echo "${WORKER_NAME}"</p>
                <p>sudo mv ${WORKER_NAME}-key.pem ${WORKER_NAME}.pem /var/lib/kubelet/</p>
                <p>sudo mv ${WORKER_NAME}.kubeconfig /var/lib/kubelet/kubeconfig</p>
                <p> sudo mv ca.pem /var/lib/kubernetes/</p>
                <p>cat &lt;&lt;EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml</br>
                kind: KubeletConfiguration</br>
                apiVersion: kubelet.config.k8s.io/v1beta1</br>
                authentication:</br>
                <span class="tab">anonymous:</span></br>
                <span class="tab2">enabled: false</span></br>
                <span class="tab">webhook:</span></br>
                <span class="tab2">enabled: true</span></br>
                <span class="tab">x509:</span></br>
                <span class="tab2">clientCAFile: "/var/lib/kubernetes/ca.pem"</span></br>
                authorization:</br>
                <span class="tab">mode: Webhook</span></br>
                clusterDomain: "cluster.local"</br>
                clusterDNS:</br>
                <span class="tab"></span>- "10.32.0.10"</br>
                podCIDR: "${POD_CIDR}"</br>
                runtimeRequestTimeout: "15m"</br>
                tlsCertFile: "/var/lib/kubelet/${WORKER_NAME}.pem"</br>
                tlsPrivateKeyFile: "/var/lib/kubelet/${WORKER_NAME}-key.pem"</br>
                resolvConf: "/run/systemd/resolve/resolv.conf"</br>
                EOF</p>
                <p>cat /var/lib/kubelet/kubelet-config.yaml</p>
                <p>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service</br>
                [Unit]</br>
                Description=Kubernetes Kubelet</br>
                Documentation=https://github.com/kubernetes/kubernetes</br>
                After=containerd.service</br>
                Requires=containerd.service</br>
                </br>    
                [Service]</br>
                ExecStart=/usr/local/bin/kubelet \\</br>
                <span class="tab">--config=/var/lib/kubelet/kubelet-config.yaml \\</span></br>
                <span class="tab">--container-runtime=remote \\</span></br>
                <span class="tab">--container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\</span></br>
                <span class="tab">--image-pull-progress-deadline=2m \\</span></br>
                <span class="tab">--kubeconfig=/var/lib/kubelet/kubeconfig \\</span></br>
                <span class="tab">--network-plugin=cni \\</span></br>
                <span class="tab">--register-node=true \\</span></br>
                <span class="tab">--v=2</span></br>
                Restart=on-failure</br>
                RestartSec=5</br>
                </br>    
                [Install]</br>
                WantedBy=multi-user.target</br>
                EOF</p>
            </div>
            <h3>Configurando Proxy</h3>
            <div class="code-worker">
                <p>sudo mv kube-proxy.kubeconfig /var/lib/kube-proxy/kubeconfig</p>
                <P>cat &lt;&lt;EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml</br>
                kind: KubeProxyConfiguration</br>
                apiVersion: kubeproxy.config.k8s.io/v1alpha1</br>
                clientConnection:</br>
                <span class="tab">kubeconfig: "/var/lib/kube-proxy/kubeconfig"</span></br>
                mode: "iptables"</br>
                clusterCIDR: "10.200.0.0/16"</br>
                EOF</P>
                <p>cat /var/lib/kube-proxy/kube-proxy-config.yaml</p>
                <p>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-proxy.service</br>
                [Unit]</br>
                Description=Kubernetes Kube Proxy</br>
                Documentation=https://github.com/kubernetes/kubernetes</br>
                </br>
                [Service]</br>
                ExecStart=/usr/local/bin/kube-proxy \\</br>
                <span class="tab">--config=/var/lib/kube-proxy/kube-proxy-config.yaml</span></br>
                Restart=on-failure</br>
                RestartSec=5</br>
                </br>
                [Install]</br>
                WantedBy=multi-user.target</br>
                EOF</p>
                <p>cat /etc/systemd/system/kube-proxy.service</p>
            </div>
            <h3>Iniciando o Serviço</h3>
            <div class="code-worker">
                <p>>sudo systemctl daemon-reload</p>
                <p>sudo systemctl enable containerd kubelet kube-proxy</p>
                <p>sudo systemctl start containerd kubelet kube-proxy</p>
            </div>
            <br/>
            <div class="atencao">
                <p>Atenção: O comando abaixo deve ser executado na sua máquina local</br>
                Pode fechar as janelas dos workers</p>
            </div>
            <h3>Verificando os Workers</h3>
            <div class="code">
                <p>external_ip=$(aws ec2 describe-instances --filters \</br>
                <span class="tab">"Name=tag:Name,Values=controller-0" \</span></br>
                <span class="tab">"Name=instance-state-name,Values=running" \</span></br>
                <span class="tab">--output text --query 'Reservations[].Instances[].PublicIpAddress')</span></p>
                <p>echo "$external_ip"</p>
                <p>ssh -i kubernetes.id_rsa ubuntu@${external_ip}</p>
                <p>kubectl get nodes --kubeconfig admin.kubeconfig</p>
            </div>
            </br>
            <p>Resultado Esperado</p>
            <table>
                <tr><td width="100">NAME</td><td width="100">STATUS</td><td width="100">ROLES</td><td width="100">AGE<td width="100">VERSION</td></tr>
                <tr><td>ip-10-0-1-20</td><td>Ready</td><td>&lt;none&gt;</td><td>51S</td><td>v1.18.6</td></tr>
                <tr><td>ip-10-0-1-21</td><td>Ready</td><td>&lt;none&gt;</td><td>51S</td><td>v1.18.6</td></tr>
                <tr><td>ip-10-0-1-22</td><td>Ready</td><td>&lt;none&gt;</td><td>51S</td><td>v1.18.6</td></tr>                
            </table>
        </div>
    </body>
</html>